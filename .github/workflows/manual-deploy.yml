name: "Manual deploy"

# Workflow dispatch to deploy on different environments
on:
  workflow_dispatch:
    inputs:
      relayer-tag:
        description: "Relayer Tag image to deploy"
        required: true
        type: string
      attester-tag:
        description: "Attester Tag image to deploy"
        required: true
        type: string
      custom-issuer-tag:
        description: "Custom Issuer Tag image to deploy"
        required: true
        type: string
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'

permissions:
  # Needed to configure aws credentials step
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      NOW: ${{ steps.env-vars.outputs.NOW }}
      TAG: ${{ steps.env-vars.outputs.TAG }}
    steps:

      # Define global vars that will be used through the pipeline
      - name: Defining global vars
        shell: bash
        id: env-vars
        run: |
          echo "NOW=$(TZ=':Europe/Madrid' date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      # Send initial Slack deployment message
      - name: üì¨ Initial Slack deployment message
        shell: bash
        env:
          NOW: ${{ steps.env-vars.outputs.NOW }}
          TAG: ${{ steps.env-vars.outputs.TAG }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "Send initial Slack message"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"üé¨ Starting *fast-auth* deployment - Commit: <https://github.com/Peersyst/fast-auth/commit/${TAG}|${TAG}> by ${GITHUB_ACTOR}\"}" ${SLACK_WEBHOOK_URL}

      # Checkout repository under $GITHUB_WORKSPACE path
      - name: Repository checkout
        uses: actions/checkout@v4

      # Assume gitHubdeploymentsRole AWS role
      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::291847425310:role/gitHubDeploymentsRole
          role-session-name: deploymentsRole
          role-duration-seconds: 900
          aws-region: us-east-1

      # Helm install
      - uses: azure/setup-helm@v3
        with:
          version: v3.12.2

      # KUBECONFIG configuration
      - name: KUBECONFIG configuration
        shell: bash
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          echo ${KUBECONFIG} | base64 --decode > kubeconfig.yaml
          chmod 600 kubeconfig.yaml
          echo ${GITHUB_WORKSPACE}
          echo "KUBECONFIG=${GITHUB_WORKSPACE}/kubeconfig.yaml" >> $GITHUB_ENV

      # Helm deployment
      - name: Helm deployment
        working-directory: ./infra/chart
        shell: bash
        env:
          NOW: ${{ steps.env-vars.outputs.NOW }}
          TAG: ${{ steps.env-vars.outputs.TAG }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          envsubst < Chart.yaml > Chart-0.yaml
          mv Chart-0.yaml Chart.yaml
          kubectl config use-context peersyst-privatenet
          helm -n fast-auth upgrade ${{ github.event.inputs.environment }} ./ --install --atomic --wait --timeout 301s --values values/${{ github.event.inputs.environment }}.yaml --set-string timestamp=${NOW} --set-string tagRelayer=${{ github.event.inputs.relayer-tag }} --set-string tagAttester=${{ github.event.inputs.attester-tag }} --set-string tagCustomIssuer=${{ github.event.inputs.custom-issuer-tag }} --debug

      # Send Slack message if any previous step has failed in this job
      - name: üì¨ Failure job notification
        if: ${{ failure() }}
        shell: sh
        env:
          NOW: ${{ steps.env-vars.outputs.NOW }}
          TAG: ${{ steps.env-vars.outputs.TAG }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "Send error Slack message"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"‚ùå *fast-auth* ${GITHUB_JOB} job *FAILED* in ${{ github.event.inputs.environment }}. Check pipeline logs <https://github.com/Peersyst/fast-auth/actions/runs/${GITHUB_RUN_ID}|here> - Commit: <https://github.com/Peersyst/fast-auth/commit/${TAG}|${TAG}> by ${GITHUB_ACTOR}\"}" ${SLACK_WEBHOOK_URL}

      # Send final Slack message if success
      - name: üì¨ Final Slack deployment message
        if: ${{ success() }}
        shell: bash
        env:
          TAG: ${{ steps.env-vars.outputs.TAG }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "Send final Slack message"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"üèÅ *fast-auth* deployment *SUCCESSFULLY* in ${{ github.event.inputs.environment }} - Commit: <https://github.com/Peersyst/fast-auth/commit/${TAG}|${TAG}> by ${GITHUB_ACTOR}\"}" ${SLACK_WEBHOOK_URL}
